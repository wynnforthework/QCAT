# Hydration é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

åŸå§‹é”™è¯¯ä¿¡æ¯ï¼š
```
Uncaught Error: Hydration failed because the server rendered text didn't match the client. 
As a result this tree will be regenerated on the client.
```

è¿™ä¸ªé”™è¯¯å‘ç”Ÿåœ¨ Next.js çš„æœåŠ¡ç«¯æ¸²æŸ“ (SSR) è¿‡ç¨‹ä¸­ï¼Œå½“æœåŠ¡ç«¯ç”Ÿæˆçš„ HTML ä¸å®¢æˆ·ç«¯ React ç»„ä»¶æ¸²æŸ“çš„å†…å®¹ä¸åŒ¹é…æ—¶ã€‚

## ğŸ”§ å·²å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ›å»ºäº†å®¢æˆ·ç«¯æ£€æµ‹å·¥å…·

**æ–‡ä»¶**: `frontend/lib/use-client-only.ts`
- `useClientOnly()` hookï¼šç¡®ä¿å†…å®¹åªåœ¨å®¢æˆ·ç«¯æ¸²æŸ“
- `useClientValue()` hookï¼šå®‰å…¨åœ°ä½¿ç”¨å¯èƒ½åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸åŒçš„å€¼

### 2. åˆ›å»ºäº†å®‰å…¨ç»„ä»¶åº“

**æ–‡ä»¶**: `frontend/components/ui/client-only.tsx`
- `ClientOnly`ï¼šåªåœ¨å®¢æˆ·ç«¯æ¸²æŸ“çš„ç»„ä»¶åŒ…è£…å™¨
- `SafeTimeDisplay`ï¼šå®‰å…¨çš„æ—¶é—´æ˜¾ç¤ºç»„ä»¶
- `SafeNumberDisplay`ï¼šå®‰å…¨çš„æ•°å­—æ ¼å¼åŒ–ç»„ä»¶
- `SafeRandomContent`ï¼šå®‰å…¨çš„éšæœºå†…å®¹ç»„ä»¶

### 3. åˆ›å»ºäº†æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨

**æ–‡ä»¶**: `frontend/lib/mock-data-generator.ts`
- ä½¿ç”¨ç§å­éšæœºæ•°ç”Ÿæˆå™¨ç¡®ä¿ä¸€è‡´æ€§
- å°†æ‰€æœ‰éšæœºæ•°æ®ç”Ÿæˆç§»åˆ°å®¢æˆ·ç«¯æ‰§è¡Œ
- æä¾›ç»Ÿä¸€çš„æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆæ¥å£

### 4. æ›´æ–°äº†ä¸»è¦ç»„ä»¶

#### å¸ƒå±€ç»„ä»¶ (`frontend/app/layout.tsx`)
- ä½¿ç”¨ `SafeTimeDisplay` æ›¿æ¢ `new Date().toLocaleTimeString()`
- ç§»é™¤äº†å¯èƒ½å¯¼è‡´ hydration é”™è¯¯çš„æ—¶é—´æ˜¾ç¤º

#### ä¸»é¡µé¢ (`frontend/app/page.tsx`)
- æ·»åŠ äº† `useClientOnly` æ£€æµ‹
- ä½¿ç”¨ `SafeNumberDisplay` æ›¿æ¢ `toLocaleString()`
- åœ¨å®¢æˆ·ç«¯å‡†å¤‡å¥½ä¹‹å‰æ˜¾ç¤ºåŠ è½½çŠ¶æ€

#### å®æ—¶ç›‘æ§ç»„ä»¶ (`frontend/components/dashboard/real-time-monitor.tsx`)
- ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨æ›¿æ¢å†…è”éšæœºæ•°ç”Ÿæˆ
- æ·»åŠ å®¢æˆ·ç«¯æ£€æµ‹ï¼Œç¡®ä¿æ•°æ®æ›´æ–°åªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
- ä½¿ç”¨ `SafeTimeDisplay` æ˜¾ç¤ºæ—¶é—´

### 5. ä¿®å¤äº†æ•°å­—æ ¼å¼åŒ–

- å°† `Intl.NumberFormat` æ›¿æ¢ä¸ºç®€å•çš„ `toFixed()` æ–¹æ³•
- ç§»é™¤äº† `toLocaleString()` çš„ä½¿ç”¨
- ç¡®ä¿æ•°å­—æ ¼å¼åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸€è‡´

### 6. åˆ›å»ºäº†æ£€æŸ¥å·¥å…·

**æ–‡ä»¶**: `frontend/scripts/check-hydration.js`
- è‡ªåŠ¨æ£€æµ‹å¯èƒ½å¯¼è‡´ hydration é”™è¯¯çš„ä»£ç æ¨¡å¼
- æä¾›ä¿®å¤å»ºè®®
- å¯ä»¥é›†æˆåˆ° CI/CD æµç¨‹ä¸­

### 7. é…ç½®äº† Next.js

**æ–‡ä»¶**: `frontend/next.config.js`
- å¯ç”¨äº† React Strict Mode
- é…ç½®äº†å®‰å…¨å¤´éƒ¨
- ä¼˜åŒ–äº†æ„å»ºé…ç½®

## ğŸ“‹ ä¿®å¤çš„å…·ä½“é—®é¢˜

### æ—¶é—´ç›¸å…³é—®é¢˜
- âŒ `new Date().toLocaleTimeString()`
- âœ… `SafeTimeDisplay` ç»„ä»¶

### éšæœºæ•°é—®é¢˜
- âŒ ç›´æ¥ä½¿ç”¨ `Math.random()`
- âœ… åœ¨ `useEffect` ä¸­ä½¿ç”¨æˆ–ä½¿ç”¨ç§å­éšæœºæ•°ç”Ÿæˆå™¨

### æ•°å­—æ ¼å¼åŒ–é—®é¢˜
- âŒ `number.toLocaleString()`
- âœ… `number.toFixed()` æˆ– `SafeNumberDisplay` ç»„ä»¶

### æµè§ˆå™¨ API é—®é¢˜
- âŒ `typeof window !== 'undefined'`
- âœ… `useClientOnly()` hook

## ğŸ§ª æµ‹è¯•é¡µé¢

åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•é¡µé¢ï¼š`frontend/app/test-hydration/page.tsx`
- æ¼”ç¤ºæ­£ç¡®çš„ hydration å¤„ç†æ–¹å¼
- å¯ä»¥ç”¨æ¥éªŒè¯ä¿®å¤æ˜¯å¦æœ‰æ•ˆ

## ğŸ“Š ä¿®å¤æ•ˆæœ

è¿è¡Œæ£€æŸ¥è„šæœ¬ `node scripts/check-hydration.js` æ˜¾ç¤ºï¼š
- å‘ç°äº† 88 ä¸ªæ½œåœ¨é—®é¢˜
- ä¸»è¦é›†ä¸­åœ¨æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆä»£ç ä¸­
- æ ¸å¿ƒç»„ä»¶çš„ hydration é—®é¢˜å·²ç»ä¿®å¤

## ğŸ¯ æœ€ä½³å®è·µ

1. **é¿å…åœ¨ç»„ä»¶åˆå§‹æ¸²æŸ“ä¸­ä½¿ç”¨åŠ¨æ€å€¼**
2. **ä½¿ç”¨ `useEffect` æ¥è®¾ç½®åŠ¨æ€å†…å®¹**
3. **ä¸ºåŠ¨æ€å†…å®¹æä¾›åˆé€‚çš„å ä½ç¬¦**
4. **ä½¿ç”¨æˆ‘ä»¬æä¾›çš„å®‰å…¨ç»„ä»¶**
5. **åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨ React Strict Mode**

## ğŸ” è°ƒè¯•å»ºè®®

1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. ä½¿ç”¨ React DevTools è¯†åˆ«ä¸åŒ¹é…çš„ç»„ä»¶
3. ä¸´æ—¶ç¦ç”¨ SSR (`ssr: false`) æ¥ç¡®è®¤æ˜¯å¦æ˜¯ hydration é—®é¢˜
4. è¿è¡Œ `node scripts/check-hydration.js` æ£€æŸ¥æ½œåœ¨é—®é¢˜

## ğŸ“ åç»­å·¥ä½œ

1. ç»§ç»­ä¿®å¤æ£€æŸ¥è„šæœ¬å‘ç°çš„å…¶ä»–é—®é¢˜
2. å°†æ£€æŸ¥è„šæœ¬é›†æˆåˆ° CI/CD æµç¨‹
3. ä¸ºå›¢é˜Ÿæˆå‘˜æä¾› hydration æœ€ä½³å®è·µåŸ¹è®­
4. è€ƒè™‘ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼è¿›ä¸€æ­¥æé«˜ä»£ç è´¨é‡

## âœ… éªŒè¯æ–¹æ³•

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š`npm run dev`
2. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
3. è®¿é—®å„ä¸ªé¡µé¢ï¼Œç¡®è®¤æ²¡æœ‰ hydration é”™è¯¯
4. è®¿é—®æµ‹è¯•é¡µé¢ `/test-hydration` éªŒè¯ä¿®å¤æ•ˆæœ
