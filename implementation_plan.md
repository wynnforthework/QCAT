# 量化合约自动化交易系统实施计划

## 项目概述
严格按照《量化合约自动化交易系统总体方案 v1.0》实施，实现"全自动、可持续优化、风险可控"的加密数字货币合约量化交易系统，满足10项自动化能力与Rules/Workflows要求。

**技术栈**：后端Go + PostgreSQL/MySQL + Redis，前端React + shadcn/ui

## 阶段一：基础架构搭建（第1-2周）

### 1.1 项目初始化
- [ ] 创建Go项目结构，配置模块化架构
- [ ] 设置PostgreSQL数据库，创建核心表结构
- [ ] 配置Redis实例（可选），设计缓存策略与降级方案
- [ ] 实现Redis可选模式：无Redis时使用内存缓存+数据库
- [ ] 创建React + shadcn/ui前端项目
- [ ] 建立CI/CD流水线

### 1.2 数据库设计
**核心表结构**：
- [ ] `strategies` - 策略基础信息
- [ ] `strategy_versions` - 策略版本管理
- [ ] `strategy_params` - 策略参数配置
- [ ] `optimizer_tasks` - 优化任务记录
- [ ] `positions` - 仓位管理
- [ ] `orders` - 订单记录
- [ ] `trades` - 成交记录
- [ ] `risk_limits` - 风控限额
- [ ] `hotlist` - 热门币种
- [ ] `audit_logs` - 审计日志
- [ ] `market_data` - 行情数据
- [ ] `performance_metrics` - 绩效指标

### 1.3 Redis缓存设计
- [ ] `md:tick:<symbol>` - 实时行情
- [ ] `md:book:<symbol>` - 盘口深度
- [ ] `md:funding:<symbol>` - 资金费率
- [ ] `sig:queue` - 策略信号队列
- [ ] `ord:pending` - 待派发订单
- [ ] `lock:*` - 分布式锁
- [ ] `rate:<exchange>` - 速率限制
- [ ] `state:pos:<strategy>:<symbol>` - 仓位状态
- [ ] `hot:score:<symbol>` - 热点分数缓存

## 阶段二：核心服务开发（第3-6周）

### 2.1 Market Ingestor（行情采集服务）
- [ ] 实现WebSocket连接管理
- [ ] 现货/合约深度数据采集
- [ ] K线数据采集与存储
- [ ] 交易数据实时采集
- [ ] Funding费率采集
- [ ] 持仓量(OI)数据采集
- [ ] 指数价格采集
- [ ] 数据质量检查与异常处理

### 2.2 Exchange Connector（交易所连接器）
- [ ] 统一交易所接口抽象
- [ ] Binance API集成
<!-- - [ ] OKX API集成 -->
<!-- - [ ] Bybit API集成 -->
- [ ] 下单/撤单功能实现
- [ ] 账户信息查询
- [ ] 仓位信息查询
- [ ] 风险限额管理
- [ ] API速率控制
- [ ] 错误重试机制

### 2.3 Strategy Runner（策略执行引擎）
- [ ] 策略沙箱环境
- [ ] 实时交易模式
- [ ] 纸交易模式
- [ ] 回测模式
- [ ] 信号生成与处理
- [ ] 订单流水管理
- [ ] 策略状态管理
- [ ] 异常处理与恢复

### 2.4 自动化能力实现 - 第一批
**能力4：自动余额驱动的建/减/平仓**
- [ ] 账户权益变动监听
- [ ] 未实现盈亏监控
- [ ] 保证金占用率检查
- [ ] 自动减仓触发机制
- [ ] 资金变更再平衡逻辑

**能力8：自动增加/启用新策略**
- [ ] Strategy SDK接口设计
- [ ] 新策略接入流程
- [ ] 纸交易→影子跟单→小额canary流程
- [ ] 策略生命周期管理
- [ ] 人工审批接口

## 阶段三：风控与仓位管理（第7-8周）

### 3.1 Risk Engine（风控引擎）
- [ ] 硬风控规则实现
  - [ ] 熔断机制
  - [ ] 限仓控制
  - [ ] 杠杆上限
  - [ ] 隔离/全仓模式
- [ ] 风控前置审批
- [ ] 多层止盈止损
  - [ ] 硬止损（账户级）
  - [ ] 策略止损（ATR/波动/时间）
  - [ ] 移动止盈（Chandelier/Parabolic）
  - [ ] 资金曲线止损
- [ ] 实时风险监控
- [ ] 告警与熔断机制

### 3.2 Portfolio Manager（投资组合管理）
- [ ] 资金分配算法
- [ ] 仓位计算公式实现
  - [ ] 目标波动率模型
  - [ ] 风险预算分配
  - [ ] Kelly公式修正
- [ ] 跨策略资本配额
- [ ] 多臂赌博机调度
  - [ ] UCB1算法
  - [ ] Thompson采样
- [ ] 再平衡机制
- [ ] 缓动约束实现

### 3.3 自动化能力实现 - 第二批
**能力3：自动优化仓位**
- [ ] 波动率目标/风险预算计算
- [ ] 权重计算公式：`w_i = min(w_max, risk_budget_i * target_vol / realized_vol_i)`
- [ ] 合约规格与最小变动值处理
- [ ] 最接近合规的下单张数生成

**能力5：自动止盈止损**
- [ ] 硬止损实现（风控层面）
- [ ] 策略止损（ATR/波动/时间）
- [ ] 移动止盈（Chandelier/Parabolic）
- [ ] 资金曲线止损（回撤阈值）
- [ ] 多层次止损协调机制

**能力7：策略淘汰制（多仓位表现）**
- [ ] 多臂赌博机资本分配
- [ ] 滚动窗口风险调整收益比较
- [ ] 末位策略限时禁用机制
- [ ] 冷却池管理
- [ ] 波动率触发优化
- [ ] 相关性触发权重调整

## 阶段四：优化与回测系统（第9-10周）

### 4.1 Optimizer（参数优化器）
- [ ] 优化触发条件检测
- [ ] Walk-Forward优化实现
- [ ] 多种搜索算法
  - [ ] 网格搜索
  - [ ] 贝叶斯优化
  - [ ] CMA-ES算法
  - [ ] 遗传算法
- [ ] 多目标优化(MOO)
- [ ] 过拟合检测
  - [ ] Deflated Sharpe
  - [ ] pBO检验
  - [ ] 参数敏感度分析
- [ ] 优化结果评估与验证

### 4.2 Backtester（回测引擎）
- [ ] 事件驱动回测框架
- [ ] 撮合引擎模拟
- [ ] 滑点模型实现
- [ ] 资金费计算
- [ ] 委托簿采样
- [ ] 延迟模型
- [ ] 费用模型
- [ ] 回测报告生成

### 4.3 自动化能力实现 - 第三批
**能力1：盈利未达预期/周期到期 → 自动优化**
- [ ] 触发器实现：`Sharpe<阈值`、`MDD>阈值`、`n日无新高`、`收益分位<q`
- [ ] 定时触发：每天UTC 00:10
- [ ] Orchestrator生成optimizer_task
- [ ] WFO执行与best_params产出
- [ ] 置信区间计算与过拟合检测

**能力2：策略自动使用最佳参数**
- [ ] 审批流实现：best_params → 风控校验
- [ ] 策略版本化管理
- [ ] Canary分配（10%资金）
- [ ] 达标后100%切换机制
- [ ] 参数更新的风控验证

**能力6：周期性自动优化**
- [ ] Cron调度器集成
- [ ] 日频/周频/事件触发
- [ ] 优化工件保存
- [ ] 指标曲线记录
- [ ] 回放与回滚功能

## 阶段五：调度与监控系统（第11-12周）

### 5.1 Orchestrator/Scheduler（任务编排器）
- [ ] Cron任务调度
  - [ ] `*/1 * * * *` 行情健康检查
  - [ ] `*/5 * * * *` 策略表现打分
  - [ ] `0 */1 * * *` 热门币种扫描
  - [ ] `10 0 * * *` 日度优化
- [ ] 事件触发机制
- [ ] 优胜劣汰算法
- [ ] 健康检查机制
- [ ] 任务队列管理

### 5.2 Hotlist Service（热门币种服务）
- [ ] 多维度打分模型
  - [ ] 波动率跳跃(VolJump)
  - [ ] 换手率(Turnover)
  - [ ] 持仓量变化(OIΔ)
  - [ ] 资金费率Z分数(FundingZ)
  - [ ] 市场状态切换(RegimeShift)
- [ ] 热门币种识别算法
- [ ] 白名单管理
- [ ] 人工审批流程

### 5.3 Monitoring & Audit（监控与审计）
- [ ] Prometheus指标收集
- [ ] 告警规则配置
- [ ] 审计日志记录
- [ ] 决策链追踪
- [ ] 性能监控
- [ ] 系统健康检查

### 5.4 自动化能力实现 - 第四批
**能力9：自动调整止盈止损线**
- [ ] 止盈止损参数函数化：`f(ATR、RV、资金曲线斜率、市场状态Regime)`
- [ ] 实时滑动更新机制
- [ ] 参数版本持久化
- [ ] 市场状态识别(Regime Detection)
- [ ] 动态阈值计算

**能力10：热门币种推荐（需手动启用）**
- [ ] 综合打分公式：`S = w1*VolJump + w2*Turnover + w3*OIΔ + w4*FundingZ + w5*RegimeShift`
- [ ] Top-N候选清单生成
- [ ] 风险标签系统（价格波动区间、杠杆安全倍数、市场情绪）
- [ ] 前端人工启用界面
- [ ] 白名单纳入机制

## 阶段六：API与前端开发（第13-15周）

### 6.1 API Gateway开发
**REST API**：
- [ ] `POST /api/optimizer/run` - 触发优化
- [ ] `POST /api/strategy/{id}/promote` - 策略升级
- [ ] `POST /api/alloc/rebalance` - 资金再平衡
- [ ] `POST /api/risk/limits` - 风控限额设置
- [ ] `POST /api/hotlist/approve` - 热门币种审批
- [ ] `GET /api/metrics/strategy/{id}` - 策略指标
- [ ] `GET /api/audit` - 审计查询

**WebSocket**：
- [ ] `ws://.../stream/market/<symbol>` - 实时行情
- [ ] `ws://.../stream/strategy/<id>` - 策略状态
- [ ] `ws://.../stream/alerts` - 告警推送

### 6.2 前端页面开发
- [ ] **总览看板**
  - [ ] 账户权益显示
  - [ ] PnL统计
  - [ ] 回撤监控
  - [ ] 策略运行状态
  - [ ] 风险指示灯
- [ ] **策略库管理**
  - [ ] 策略卡片展示
  - [ ] 版本管理
  - [ ] 绩效展示
  - [ ] 一键回测/优化
- [ ] **参数优化实验室**
  - [ ] WFO配置界面
  - [ ] 搜索空间设置
  - [ ] 目标函数选择
  - [ ] 结果可视化
  - [ ] 敏感度热图
- [ ] **资金与仓位管理**
  - [ ] 权重分配显示
  - [ ] 目标vs实际对比
  - [ ] 调仓计划
  - [ ] 操作回滚功能
- [ ] **风控中心**
  - [ ] 限额配置
  - [ ] 熔断阈值设置
  - [ ] 止盈止损模板
  - [ ] 审批流管理
- [ ] **热门币种管理**
  - [ ] 排行榜显示
  - [ ] 评分维度解释
  - [ ] 启用开关
  - [ ] 白名单管理
- [ ] **审计与回放**
  - [ ] 决策链时间线
  - [ ] 日志查询
  - [ ] 报告导出

## 阶段七：集成测试与部署（第16-17周）

### 7.1 系统集成测试
- [ ] 端到端流程测试
- [ ] 10项自动化能力验证
  1. [ ] 盈利未达预期自动优化
  2. [ ] 策略自动使用最佳参数
  3. [ ] 自动优化仓位
  4. [ ] 自动余额驱动建/减/平仓
  5. [ ] 自动止盈止损
  6. [ ] 周期性自动优化
  7. [ ] 策略淘汰制
  8. [ ] 自动增加/启用新策略
  9. [ ] 自动调整止盈止损线
  10. [ ] 热门币种推荐
- [ ] 压力测试
- [ ] 故障恢复测试
- [ ] 数据一致性测试

### 7.2 安全与合规
- [ ] API Key管理（KMS/Vault）
- [ ] 权限控制(RBAC)
- [ ] 审批流程(4-eyes)
- [ ] 审计日志完整性
- [ ] 数据加密
- [ ] 网络安全配置

### 7.3 部署与运维
- [ ] 生产环境部署
- [ ] 监控告警配置
- [ ] 备份恢复策略
- [ ] 运维文档编写
- [ ] 用户培训

### 7.4 系统稳定性保障
- [ ] **进程分离**：策略执行与优化分开进程，优化时不阻塞实盘交易
- [ ] **Redis降级**：Redis故障时自动切换到内存缓存+数据库模式
- [ ] **API限流**：增加速率限制，防止策略短时间内请求过多导致交易所限流
- [ ] **数据库连接池**：配置合理的连接池大小，避免连接耗尽
- [ ] **内存管理**：实现内存监控与垃圾回收优化
- [ ] **网络重连**：WebSocket断线自动重连机制
- [ ] **服务健康检查**：各服务模块健康状态监控
- [ ] **优雅关闭**：系统关闭时保证数据完整性和订单安全

### 7.5 生产就绪检查清单
- [ ] **配置管理**：环境变量配置，敏感信息加密存储
- [ ] **日志系统**：结构化日志，日志轮转，错误追踪
- [ ] **性能基准**：建立性能基线，延迟监控
- [ ] **容灾方案**：数据备份，服务故障转移
- [ ] **监控大屏**：实时监控面板，关键指标展示
- [ ] **告警通道**：邮件/短信/钉钉等多渠道告警
- [ ] **文档完整性**：API文档，运维手册，故障处理手册
- [ ] **权限审计**：用户权限分配，操作审计日志

## 阶段八：优化与维护（第18周+）

### 8.1 性能优化
- [ ] 系统性能调优
- [ ] 数据库优化
- [ ] 缓存策略优化
- [ ] 网络延迟优化

### 8.2 功能增强
- [ ] 新交易所接入
- [ ] 新策略类型支持
- [ ] 高级风控功能
- [ ] 更多优化算法

### 8.3 持续维护
- [ ] Bug修复
- [ ] 功能迭代
- [ ] 系统监控
- [ ] 用户反馈处理

## 关键里程碑

- **第2周末**：基础架构完成，数据库和缓存就绪
- **第6周末**：核心服务开发完成，基本交易功能可用
- **第8周末**：风控和仓位管理完成，系统安全可控
- **第10周末**：优化和回测系统完成，自动化能力基本具备
- **第12周末**：调度和监控系统完成，全自动化运行
- **第15周末**：前端和API完成，用户界面可用
- **第17周末**：系统集成测试完成，生产环境部署
- **第18周**：系统正式上线运行

## 风险控制

1. **技术风险**：采用成熟技术栈，分阶段开发，及时测试验证
2. **进度风险**：预留缓冲时间，关键路径优先，并行开发
3. **质量风险**：严格代码审查，完整测试覆盖，灰度发布
4. **安全风险**：多层安全防护，权限最小化，审计全覆盖

## 资源需求

- **开发团队**：后端开发2人，前端开发1人，测试1人
- **基础设施**：数据库服务器，Redis服务器，应用服务器
- **外部依赖**：交易所API，行情数据源，监控告警服务

## 成功标准

系统成功实现方案中定义的10项自动化能力，通过全面测试验证，在生产环境稳定运行，满足"全自动、可持续优化、风险可控"的目标要求。