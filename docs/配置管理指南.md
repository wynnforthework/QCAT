# QCAT 配置管理指南

## 概述

QCAT 采用统一的配置管理方案，支持多种配置方式，确保配置的安全性和灵活性。

## 配置层次结构

配置按以下优先级加载（从高到低）：

1. **环境变量** - 最高优先级，用于覆盖敏感配置
2. **环境变量文件 (.env)** - 本地开发环境配置
3. **配置文件 (config.yaml)** - 基础配置模板

## 配置文件结构

### 1. 主配置文件 (configs/config.yaml)

这是项目的基础配置文件，包含所有配置项的默认值和结构定义。

**特点：**
- 不包含敏感信息
- 使用环境变量占位符 `${VARIABLE_NAME}`
- 可以安全地提交到版本控制系统

**示例：**
```yaml
database:
  host: "localhost"
  port: 5432
  user: "postgres"
  password: "${DATABASE_PASSWORD}"  # 使用环境变量占位符
  dbname: "qcat"

redis:
  enabled: true
  addr: "localhost:6379"
  password: "${REDIS_PASSWORD}"     # 使用环境变量占位符
```

### 2. 环境变量模板 (deploy/env.example)

这是环境变量的模板文件，包含所有可配置的环境变量。

**特点：**
- 不包含真实值，只有占位符
- 可以安全地提交到版本控制系统
- 用户需要复制为 `.env` 并填入真实值

**示例：**
```bash
# 数据库配置
QCAT_DATABASE_PASSWORD=your_secure_database_password
QCAT_DATABASE_NAME=qcat

# Redis配置
QCAT_REDIS_ENABLED=true
QCAT_REDIS_PASSWORD=your_secure_redis_password

# 交易所配置
EXCHANGE_API_KEY=your_binance_api_key
EXCHANGE_API_SECRET=your_binance_api_secret
```

### 3. 本地环境变量文件 (.env)

这是本地开发环境的实际配置文件，包含真实的配置值。

**特点：**
- 包含敏感信息
- 不应提交到版本控制系统
- 由用户根据 `deploy/env.example` 创建

## 配置分类

### 基础配置

- **应用配置**: 应用名称、版本、环境
- **服务器配置**: 端口、超时设置
- **数据库配置**: 连接信息、连接池设置
- **Redis配置**: 连接信息、是否启用

### 安全配置

- **JWT配置**: 密钥、有效期
- **加密配置**: 算法、密钥管理
- **TLS配置**: 证书路径、加密套件

### 业务配置

- **交易所配置**: API密钥、URL、限流设置
- **策略配置**: 默认模式、并发数、超时
- **优化器配置**: 算法、迭代次数、并发数
- **风险管理配置**: 阈值、监控设置
- **市场数据配置**: 缓存、批处理、数据类型

## 环境变量命名规范

所有环境变量使用 `QCAT_` 前缀，采用大写字母和下划线分隔：

```
QCAT_[SECTION]_[SUBSECTION]_[KEY]
```

**示例：**
- `QCAT_DATABASE_PASSWORD`
- `QCAT_REDIS_ENABLED`
- `EXCHANGE_API_KEY`
- `QCAT_SECURITY_KMS_MASTER_KEY`

## 配置管理工具

QCAT 提供了专门的配置管理工具 `qcat-config`，支持以下功能：

### 1. 配置验证

验证配置文件的完整性和正确性：

```bash
# 使用 Makefile
make config-validate

# 直接使用工具
go run cmd/config/main.go -validate
```

### 2. 生成环境变量模板

生成环境变量模板文件：

```bash
# 使用 Makefile
make config-generate

# 直接使用工具
go run cmd/config/main.go -generate -env .env.example
```

### 3. 加密/解密敏感信息

加密敏感信息用于环境变量：

```bash
# 加密
make config-encrypt TEXT="my-secret-password"

# 解密
make config-decrypt TEXT="ENC:encrypted-string"
```

## 快速开始

### 1. 初始化配置

```bash
# 生成环境变量模板
make config-generate

# 复制并编辑环境变量文件
cp .env.example .env
# 编辑 .env 文件，填入真实配置值
```

### 2. 验证配置

```bash
# 验证配置文件
make config-validate
```

### 3. 启动应用

```bash
# 启动本地开发环境
make start-local
```

## 环境特定配置

### 开发环境

```bash
QCAT_APP_ENVIRONMENT=development
EXCHANGE_TEST_NET=true
QCAT_REDIS_ENABLED=true
```

### 生产环境

```bash
QCAT_APP_ENVIRONMENT=production
EXCHANGE_TEST_NET=false
QCAT_REDIS_ENABLED=true
QCAT_SECURITY_TLS_ENABLED=true
```

## 安全最佳实践

### 1. 敏感信息管理

- 永远不要在配置文件中硬编码敏感信息
- 使用环境变量存储敏感信息
- 考虑使用加密的环境变量

### 2. 环境变量加密

对于特别敏感的信息，可以使用加密的环境变量：

```bash
# 设置加密密钥
export QCAT_ENCRYPTION_KEY="your-encryption-key"

# 加密敏感信息
make config-encrypt TEXT="my-super-secret-password"

# 在 .env 文件中使用加密值
QCAT_DATABASE_PASSWORD=ENC:encrypted-value
```

### 3. 文件权限

确保敏感配置文件具有适当的权限：

```bash
chmod 600 .env
chmod 600 configs/config.yaml
```

## 配置验证规则

配置验证器会检查以下内容：

### 必需字段
- 应用名称、版本、环境
- 数据库连接信息
- JWT密钥
- 交易所API配置

### 格式验证
- URL格式
- 端口号范围
- 时间格式
- 数值范围

### 逻辑验证
- 连接池大小关系
- 超时设置合理性
- 阈值范围检查

## 故障排除

### 常见问题

1. **配置验证失败**
   - 检查必需的环境变量是否设置
   - 验证配置文件格式是否正确
   - 确认数值范围是否合理

2. **环境变量未生效**
   - 确认环境变量名称是否正确
   - 检查环境变量文件是否被正确加载
   - 验证环境变量前缀是否为 `QCAT_`

3. **加密/解密失败**
   - 确认 `QCAT_ENCRYPTION_KEY` 环境变量已设置
   - 检查加密密钥是否一致
   - 验证加密格式是否正确

### 调试技巧

1. **查看配置摘要**
   ```bash
   make config-validate
   ```

2. **检查环境变量**
   ```bash
   env | grep QCAT_
   ```

3. **验证配置文件语法**
   ```bash
   yamllint configs/config.yaml
   ```

## 扩展配置

### 添加新的配置项

1. 在 `internal/config/config.go` 中添加结构体字段
2. 在 `configs/config.yaml` 中添加默认值
3. 在 `deploy/env.example` 中添加环境变量模板
4. 在 `internal/config/config.go` 的 `overrideWithEnv` 方法中添加环境变量覆盖逻辑
5. 在 `internal/config/validator.go` 中添加验证规则

### 配置热重载

QCAT 支持配置热重载功能，可以通过 API 或信号重新加载配置：

```bash
# 发送重载信号
kill -HUP <pid>
```

## 总结

QCAT 的配置管理方案提供了：

- **统一性**: 所有配置通过统一的接口管理
- **安全性**: 敏感信息通过环境变量管理，支持加密
- **灵活性**: 支持多种配置方式和环境特定配置
- **可验证性**: 提供配置验证工具确保配置正确性
- **可维护性**: 清晰的配置结构和文档

通过遵循本指南，您可以安全、高效地管理 QCAT 的配置。
