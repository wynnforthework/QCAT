# QCAT 项目代码扫描报告
graph TB
    subgraph "QCAT 量化交易系统架构"
        subgraph "前端层 (React + Next.js + shadcn/ui)"
            FE_Dashboard["仪表板"]
            FE_Strategy["策略管理"]
            FE_Portfolio["投资组合"]
            FE_Risk["风险控制"]
            FE_Optimizer["优化器"]
            FE_Hotlist["热门币种"]
            FE_Audit["审计日志"]
        end

        subgraph "API层 (Gin + WebSocket)"
            API_Server["API服务器"]
            API_Auth["认证中间件"]
            API_RateLimit["限流中间件"]
            API_Security["安全中间件"]
            API_WS["WebSocket"]
        end

        subgraph "业务逻辑层"
            subgraph "策略模块"
                STRAT_Engine["策略引擎"]
                STRAT_Live["实盘策略"]
                STRAT_Paper["纸上交易"]
                STRAT_Backtest["回测引擎"]
                STRAT_SDK["策略SDK"]
                STRAT_Optimizer["策略优化器"]
            end

            subgraph "交易模块"
                EXCH_Manager["交易所管理器"]
                EXCH_Order["订单管理"]
                EXCH_Position["仓位管理"]
                EXCH_Portfolio["投资组合"]
                EXCH_Risk["风险管理"]
                EXCH_PnL["盈亏计算"]
            end

            subgraph "市场数据模块"
                MARKET_Ingestor["数据采集器"]
                MARKET_Kline["K线管理"]
                MARKET_OrderBook["订单簿"]
                MARKET_Trade["交易数据"]
                MARKET_WS["WebSocket客户端"]
            end

            subgraph "编排器模块"
                ORCH_Main["主编排器"]
                ORCH_Process["进程管理器"]
                ORCH_Message["消息队列"]
                ORCH_Monitor["进程监控"]
            end

            subgraph "监控与稳定性"
                STAB_Health["健康检查"]
                STAB_Memory["内存管理"]
                STAB_Network["网络重连"]
                STAB_Shutdown["优雅关闭"]
                MON_Metrics["指标收集"]
                MON_Alerts["告警管理"]
            end

            subgraph "安全模块"
                SEC_Auth["身份认证"]
                SEC_Keys["密钥管理"]
                SEC_Audit["审计日志"]
                SEC_RBAC["权限控制"]
                SEC_Monitor["安全监控"]
            end

            subgraph "热门检测"
                HOT_Detector["热门检测器"]
                HOT_Scorer["评分器"]
                HOT_Manager["热门管理"]
            end
        end

        subgraph "基础设施层"
            DB["PostgreSQL<br/>数据库"]
            CACHE["Redis<br/>缓存"]
            CONFIG["配置管理"]
            LOGGER["日志系统"]
        end

        subgraph "外部服务"
            BINANCE["币安API"]
            PROMETHEUS["Prometheus"]
            GRAFANA["Grafana"]
        end
    end

    %% 前端到API层连接
    FE_Dashboard --> API_Server
    FE_Strategy --> API_Server
    FE_Portfolio --> API_Server
    FE_Risk --> API_Server
    FE_Optimizer --> API_Server
    FE_Hotlist --> API_Server
    FE_Audit --> API_Server
    
    %% API层内部连接
    API_Server --> API_Auth
    API_Server --> API_RateLimit
    API_Server --> API_Security
    API_Server --> API_WS

    %% API层到业务逻辑层
    API_Server --> STRAT_Engine
    API_Server --> EXCH_Manager
    API_Server --> MARKET_Ingestor
    API_Server --> ORCH_Main
    API_Server --> HOT_Manager

    %% 策略模块内部连接
    STRAT_Engine --> STRAT_Live
    STRAT_Engine --> STRAT_Paper
    STRAT_Engine --> STRAT_Backtest
    STRAT_Engine --> STRAT_SDK
    STRAT_Optimizer --> STRAT_Engine

    %% 交易模块内部连接
    EXCH_Manager --> EXCH_Order
    EXCH_Manager --> EXCH_Position
    EXCH_Manager --> EXCH_Portfolio
    EXCH_Manager --> EXCH_Risk
    EXCH_Manager --> EXCH_PnL

    %% 市场数据模块内部连接
    MARKET_Ingestor --> MARKET_Kline
    MARKET_Ingestor --> MARKET_OrderBook
    MARKET_Ingestor --> MARKET_Trade
    MARKET_Ingestor --> MARKET_WS

    %% 编排器模块内部连接
    ORCH_Main --> ORCH_Process
    ORCH_Main --> ORCH_Message
    ORCH_Main --> ORCH_Monitor

    %% 监控模块连接
    STAB_Health --> MON_Metrics
    STAB_Memory --> MON_Metrics
    STAB_Network --> MON_Metrics
    MON_Metrics --> MON_Alerts

    %% 安全模块内部连接
    SEC_Auth --> SEC_Keys
    SEC_Auth --> SEC_Audit
    SEC_Auth --> SEC_RBAC
    SEC_Monitor --> SEC_Audit

    %% 热门检测模块
    HOT_Detector --> HOT_Scorer
    HOT_Manager --> HOT_Detector

    %% 基础设施层连接
    STRAT_Engine --> DB
    EXCH_Manager --> DB
    MARKET_Ingestor --> DB
    SEC_Audit --> DB
    
    STRAT_Engine --> CACHE
    EXCH_Manager --> CACHE
    MARKET_Ingestor --> CACHE
    
    STRAT_Engine --> CONFIG
    EXCH_Manager --> CONFIG
    API_Server --> CONFIG
    
    %% 外部服务连接
    MARKET_WS --> BINANCE
    EXCH_Manager --> BINANCE
    MON_Metrics --> PROMETHEUS
    PROMETHEUS --> GRAFANA
    
基于对整个项目的深入扫描，我为您提供以下详细报告：

## 1. 架构图（模块/目录/文件及依赖关系）

如上方的架构图所示，QCAT 是一个完整的量化合约自动化交易系统，采用分层架构设计：

### 技术栈
- **后端**: Go 1.23 + Gin + WebSocket + PostgreSQL + Redis  
- **前端**: React 19 + Next.js 15 + TypeScript + shadcn/ui + Tailwind CSS
- **监控**: Prometheus + Grafana
- **部署**: Docker + Docker Compose

### 主要模块层次
1. **前端层**: 基于 React + Next.js 的现代化 Web 界面
2. **API层**: Gin 框架的 RESTful API 和 WebSocket 实时通信
3. **业务逻辑层**: 核心交易、策略、市场数据处理模块
4. **基础设施层**: 数据库、缓存、配置、日志系统
5. **外部服务**: 币安API、监控系统

## 2. 每个模块的主要功能说明

### 2.1 前端模块 (`frontend/`)
- **Dashboard**: 总览仪表板，显示系统状态和核心指标
- **Strategy**: 策略管理界面，包括策略配置、启停、性能监控
- **Portfolio**: 投资组合管理，包括资产配置、风险预算、再平衡
- **Risk**: 风险控制界面，包括风险限额、熔断器、违规监控
- **Optimizer**: 策略优化器界面，支持多种优化算法
- **Hotlist**: 热门币种检测和白名单管理
- **Audit**: 审计日志查看和决策链追踪

### 2.2 API模块 (`internal/api/`)
- **服务器**: 基于 Gin 的 HTTP 服务器，支持中间件和路由
- **认证**: JWT 令牌管理和用户认证
- **限流**: 可配置的请求速率限制
- **安全**: API 安全防护和输入验证
- **WebSocket**: 实时数据推送和双向通信

### 2.3 策略模块 (`internal/strategy/`)
- **策略引擎**: 统一的策略执行框架
- **策略SDK**: 策略开发接口和基础类
- **实盘交易**: 真实市场环境下的策略执行
- **纸上交易**: 模拟交易环境
- **回测引擎**: 历史数据回测和性能评估
- **优化器**: 多种优化算法（网格搜索、贝叶斯、遗传算法等）

### 2.4 交易模块 (`internal/exchange/`)
- **交易所管理**: 支持币安等交易所的统一接口
- **订单管理**: 订单生命周期管理和状态跟踪
- **仓位管理**: 持仓跟踪和资金管理
- **投资组合**: 资产配置和风险预算管理
- **风险控制**: 多层次风险限制和熔断机制
- **盈亏计算**: 实时和历史盈亏计算

### 2.5 市场数据模块 (`internal/market/`)
- **数据采集**: 多数据源的实时市场数据采集
- **K线管理**: K线数据存储和查询
- **订单簿**: 实时订单簿数据处理
- **交易数据**: 成交数据采集和处理
- **WebSocket**: 与交易所的实时数据连接

### 2.6 编排器模块 (`internal/orchestrator/`)
- **主编排器**: 系统级任务调度和协调
- **进程管理**: 多进程服务管理和监控
- **消息队列**: 进程间通信和事件传递
- **任务调度**: 定时任务和触发式任务管理

### 2.7 监控与稳定性模块 (`internal/monitoring/`, `internal/stability/`)
- **健康检查**: 服务状态监控和故障检测
- **内存管理**: 内存使用监控和垃圾回收优化
- **网络重连**: 网络连接故障自动恢复
- **优雅关闭**: 系统安全关闭和资源清理
- **指标收集**: Prometheus 指标收集
- **告警管理**: 多渠道告警通知

### 2.8 安全模块 (`internal/security/`)
- **身份认证**: JWT 和 API 密钥认证
- **密钥管理**: API 密钥生命周期管理
- **审计日志**: 完整的操作审计追踪
- **权限控制**: 基于角色的访问控制 (RBAC)
- **安全监控**: 安全事件监控和告警

### 2.9 热门检测模块 (`internal/hotlist/`)
- **热门检测**: 基于多因子的热门币种识别
- **评分算法**: 综合评分和排名机制
- **白名单管理**: 可交易币种管理

## 3. 所有 TODO、临时代码、硬编码、未实现的部分清单

### 3.1 TODO 和未实现部分

#### 主要 TODO 项目：
1. **策略优化器**: `cmd/optimizer/main.go:246` - 实际优化逻辑实现
2. **编排器消息处理**: `internal/orchestrator/orchestrator.go:307-328` - 优化结果处理、进程退出处理、交易信号转发、市场数据更新处理
3. **进程监控**: `internal/orchestrator/process_monitor.go:284,291` - CPU 和内存使用监控的实际实现
4. **Redis 消息队列**: `internal/orchestrator/message_queue.go:168` - Redis pub/sub 实际实现
5. **未实现盈亏监控**: 多个文件中涉及未实现盈亏计算的完整业务逻辑

#### 完全未实现的功能：
- **数据库存储**: `internal/security/storage.go:234-259` - 数据库保险库存储
- **数据库审计**: `internal/security/vault.go:57` - 数据库存储
- **缓存接口**: `internal/cache/fallback_test.go:331-436` - 测试用的模拟缓存接口方法

### 3.2 硬编码部分

#### 策略优化器硬编码：
- `internal/strategy/optimizer/search.go` - 硬编码的网格大小(10)
- `internal/strategy/optimizer/elimination.go` - 硬编码的窗口大小(20天)
- `internal/strategy/optimizer/overfitting.go` - 硬编码的收缩因子计算
- `internal/strategy/optimizer/position.go` - 硬编码的权重限制(20%)
- `internal/strategy/optimizer/trigger.go` - 硬编码的惩罚系数

#### 其他硬编码：
- `internal/alerting/channels.go` - 多个模板字符串硬编码
- `internal/automation/report/report.go` - 硬编码的HTML模板
- `deploy/prometheus.yml` - 硬编码的控制台模板路径
- 风险管理模块中的维持保证金率 (10%)

### 3.3 临时代码和模拟数据

#### 临时实现：
- `test/integration/system_test.go:103,129,212` - 临时的交易所接口和参数
- `internal/strategy/optimizer/walkforward.go:172-173` - 临时使用空的性能统计结构体
- `internal/testutils/testutils.go:124,145` - 内存数据库和缓存的临时实现

#### 模拟数据：
- **前端大量使用模拟数据**: 所有页面都使用 `generateMock*` 函数生成测试数据
- **测试文件**: 广泛使用 `MockData` 类生成随机测试数据
- **缓存测试**: `internal/cache/fallback_test.go` 中完整的模拟 Redis 缓存实现

#### Placeholder 实现：
- `scripts/build_services.sh:19-33` - 占位符服务构建脚本
- `internal/orchestrator/process_monitor.go:282` - CPU 使用率获取的占位符实现
- `internal/security/monitor.go:359` - 生产环境集成的占位符

### 3.4 配置和文档问题

#### 配置化需求：
- 大量硬编码参数需要移到配置文件
- 部分配置文件缺少示例或文档
- 环境变量配置不完整

#### 文档完整性：
- API 文档需要完善
- 部署文档需要更新
- 用户手册需要补充

## 总结

QCAT 是一个架构完整、功能丰富的量化交易系统，但仍有以下主要改进点：

1. **完成核心功能实现**: 特别是未实现盈亏监控、实际优化算法等
2. **配置化硬编码参数**: 将硬编码值移到配置文件中
3. **替换模拟数据**: 将前端和测试中的模拟数据替换为真实数据连接
4. **完善数据库功能**: 实现缺失的数据库存储功能
5. **增强监控告警**: 完善系统监控和告警机制
6. **优化性能**: 解决临时实现和性能瓶颈

整体而言，系统的架构设计合理，模块划分清晰，具备了生产环境运行的基础框架，需要进一步完善具体实现细节。